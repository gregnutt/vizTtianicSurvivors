<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<script src="http://d3js.org/d3.v3.min.js"></script>

		<style></style>

		<script type="text/javascript">

	        var i, j;

	        function data_trim(d, field, null_value) { 
	        	// Abstracted function to remove empty values from the dataset
	        	var null_entries = [];

	        	for (i = 0; i < d.length; i++) {
	        		if (d[i][field] == null_value) {
	        			null_entries.push(i);
	        		}
	        	}
	        	for (i = 0; i < null_entries.length; i++) {
	        		d.splice(null_entries[i]-i, 1);
	        	}

	        	return d;
	        }


	        var setupStack = function setupStack(data){
	       	// Function to split bar above and below xAxis
	        	for (var i = 0; i < data.length; i++) {
	        		// Above Axis
	        		var baseSurvived = 0;
	        		// Below Axis
	        		var baseDied = 0;

	        		for (var j = 0; j < data[i][j].length; j++) {
	        			// For each passenger in the group
	        			passenger = data[i][j];

	        			if (passenger.Survived === 0) {
	        				passenger.y0 = baseDied;
	        				baseDied -= 1;
	        			} else if (passenger.Survived === 1) {
	        				baseSurvived += 1;
	        				passenger.y0 = baseSurvived;
	        			}
	        		}
	        	}
	        	return data;
	        };

	        // Setup SVG space
	        var margin = 75,
	            width = 1400 - margin,
	            height = 600 - margin;

	        var svg = d3.select("body")
	            .append("svg")
	              .attr("width", width + margin)
	              .attr("height", height + margin);

	        var chart = svg.append('g').attr('class','chart');
	        var xAxisGroup = svg.append('g').attr('class', 'x axis');
	        var yAxisGroup = svg.append('g').attr('class', 'y axis');

	        // Setup Scales and Axes
	        var updateScales = function updateScales() {
	        	var xScale = d3.scale.ordinal()
	        		.domain(data.map(function(d) {
						        	 	return d[0].AgeRange;
						        	}))
	        		.rangeRoundBands([margin, width - margin], 0.05);

	        	var merged = d3.merge(data);
	        	var yScale = d3.scale.linear()
	        				   .domain([
	        				   		// the min is the base y (y0) minus 1 for the count
	        				   		d3.min(merged, function(d) { return d.y0 - d.size; }),
	        				   		// y0 wil contain the highest value
	        				   		d3.max(merged, function(d) { return d.y0; })
	        				   	])
	        				   .range([height - margin, margin]);
	        };

	        var updateAxis = function() {
	        	var xAxis = d3.svg.axis()
	        				  .scale(xScale)
	        				  .orient('bottom')
	        				  .tickSize(6, 0);

	        	var yAxis = d3.svg.axis()
	        				  .scale(yScale)
	        				  .orient('left');

	        	xAxisGroup.transition()
	        			  .attr('transform', 'translate (' + [0, yScale(0)] + ')')
	        			  .call(xAxis);
	        	yAxisGroup.transition()
	        			  .attr('transform', 'translate (' + [xScale(margin), 0] + ')')
	        			  .call(yAxis);
	        };

	        // Update Bars
	        var updateBars = function() {

	        	var color = {
	        				  'male'   : '#3399FF',
	        				  'female' : '#FF3399'
	        				};

	        	// Group setup
	        	var barGroups = chartGroup.selectAll('.barGroup')
	        							  .data(data);
				barGroups.enter()
						 .append('svg:g')
						 .attr('class': 'barGroup');

				// Stacked group setup
				var bars = barGroups.selectAll('.bar')
						 			.data(function(d) { return d; });

				bars.enter()
					.append('svg:rect')
					.attr('class', 'bar')
					.attr('width', xScale.rangeBand())
					.attr('x', function(d, i) { return xScale(d.AgeRange); })
					.attr('y', function(d, i) { return yScale(d.y0); })
					.attr('height', function(d, i) {
										return (yScale(0) - yScale(d.size)) / 2;
									})
					.style('fill', function(d) { return color(d.sex); });

				bars.transition()
					.attr('width', xScale.rangeBand())
					.attr('x', function(d, i) { return xScale(d.AgeRange); })
					.attr('y', function(d, i) { return yScale(d.y0); })
					.attr('height', function(d, i) { return yScale(0) - yScale(d.size); });

        		return bars;
	        };

			var updateChart = function updateChart(data) {
			    /*
			      D3.js setup code
			    */
		        "use strict";
		        debugger;
		        // Format the data //
		        // Remove any empty values for Age, Fare, and Embarked
		        data = data_trim(data, 'Age', 0);
		        data = data_trim(data, 'Fare', 0);
		        data = data_trim(data, 'Embarked', "");
		        debugger;

		        // Bin Passengers by age group
		        for (i = 0; i < data.length; i++) {
	        		if (data[i].Age < 10) {
				  		data[i].AgeRange = '<10 Years';
	        		}
				  	else if (data[i].Age >= 10 && data[i].Age < 20) {
				  		data[i].AgeRange = '10 to 20 Years';
				  	}
				  	else if (data[i].Age >= 20 && data[i].Age < 30) {
				  		data[i].AgeRange = '20 to 30 Years';
				  	}
				  	else if (data[i].Age >= 30 && data[i].Age < 40) {
				  		data[i].AgeRange = '30 to 40 Years';
				  	}
				  	else if (data[i].Age >= 40 && data[i].Age < 50) {
				  		data[i].AgeRange = '40 to 50 Years';
				  	}
				  	else if (data[i].Age >= 50 && data[i].Age < 60) {
				  		data[i].AgeRange = '50 to 60 Years';
				  	}
				  	else if (data[i].Age >= 60) {
				  		data[i].AgeRange = '60+ Years';
				  	}
		        }
		        debugger;

		        data = setupStack(data);
		        debugger;

		        updateScales();
		        debugger;

		        updateAxis();
		        debugger;

		        updateBars();
		        debugger;
			};
		</script>
	</head>
	<body>
		<script type="text/javascript">
			// load the dataset
			d3.csv('titanic_survivors.csv', function(d) {
				d.Survived = +d.Survived;
				d.Age = +d.Age;
				d.SibSp = +d.SibSp;
				d.Parch = +d.Parch;
				d.Fare = +d.Fare;
				switch (d.Embarked) {
				  	case 'C':
				  		d.Embarked = 'Cherbourg, France';
				  		break;
				  	case 'Q':
				  		d.Embarked = 'Queenstown, Ireland';
				  		break;
				  	case 'S':
						d.Embarked = 'Southampton, UK';
				  		break;
				}
			    return d;
			}, updateChart);
		</script>
	</body>
</html>