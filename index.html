<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<script src="http://d3js.org/d3.v3.min.js"></script>

		<style>
			.axis text {
				  font: 10px sans-serif;
				}

			.axis path,
			.axis line {
				  fill: none;
				  stroke: #000;
				  shape-rendering: crispEdges;
				}
		</style>

		<script type="text/javascript">

	        var ageRanges = [
	        	'<10 Years',
	        	'10 to 20 Years',
	        	'20 to 30 Years',
	        	'30 to 40 Years',
	        	'40 to 50 Years',
	        	'50 to 60 Years',
	        	'60+ Years'
	        ];
	        var i, j;
	        var sortField;

	        function dataTrim(d, field, null_value) {
	        	// Abstracted function to remove empty values from the dataset
	        	var null_entries = [];

	        	for (i = 0; i < d.length; i++) {
	        		if (d[i][field] == null_value) {
	        			null_entries.push(i);
	        		}
	        	}
	        	for (i = 0; i < null_entries.length; i++) {
	        		d.splice(null_entries[i]-i, 1);
	        	}

	        	return d;
	        }

	        function sortData(data, sort_field) {
	        	var sortFxn = function(a, b) { 
				        			var keyA = a[sort_field],
				        				keyB = b[sort_field];
				        			if (keyA < keyB) { return -1; }
				        			if (keyA > keyB) { return  1; }
				        			return 0; 
				        		};
		        for (i = 0; i < data.length; i++) {
		        	data[i].sort(sortFxn);
		        }
		        return data;
	        }

	        var setupStack = function setupStack(data){
	       	// Function to split bar above and below xAxis
	        	for (var i = 0; i < data.length; i++) {
	        		// Above Axis
	        		var baseSurvived = 0;
	        		// Below Axis
	        		var baseDied = 0;

	        		for (var j = 0; j < data[i].length; j++) {
	        			// For each passenger in the group
	        			passenger = data[i][j];

	        			if (passenger.Survived === 0) {
	        				passenger.y0 = baseDied;
	        				baseDied -= 1;
	        			} else if (passenger.Survived === 1) {
	        				baseSurvived += 1;
	        				passenger.y0 = baseSurvived;
	        			}
	        		}
	        	}
	        	return data;
	        };

	        var margin, width, height;
	        var svg, chartGroup, xAxisGroup, yAxisGroup;

	        var setupSpace = function setupSpace() {
		        // Setup SVG space
		        margin = 75;
		        width = 1400 - margin;
		        height = 600 - margin;

		        svg = d3.select("body")
		        	    .append("svg")
		            	  .attr("width", width + margin)
		            	  .attr("height", height + margin);

		        chartGroup = svg.append('g').attr('class','chart');
		        xAxisGroup = svg.append('g').attr('class', 'x axis');
		        yAxisGroup = svg.append('g').attr('class', 'y axis');
	        }

	        var xScale, yScale, merged;

	        // Setup Scales and Axes
	        var updateScales = function updateScales(data) {
	        	xScale = d3.scale.ordinal()
	        		.domain(ageRanges)
	        		.rangeRoundBands([margin, width - margin], 0.05);

	        	var merged = d3.merge(data);

	        	yScale = d3.scale.linear()
	        				   .domain([
	        				   		// the min is the base y (y0) minus 1 for the count
	        				   		d3.min(merged, function(d) { return d.y0 - 1; }),
	        				   		// y0 wil contain the highest value
	        				   		d3.max(merged, function(d) { return d.y0; })
	        				   	])
	        				   .range([height - margin, margin]);
	        };

	        var updateAxis = function() {
	        	var xAxis = d3.svg.axis()
	        				  .scale(xScale)
	        				  .orient('bottom')
	        				  .tickSize(6, 0);

	        	var yAxis = d3.svg.axis()
	        				  .scale(yScale)
	        				  .orient('left');

	        	xAxisGroup.transition()
	        			  .attr('transform', 'translate (' + [0, yScale(0)] + ')')
	        			  .call(xAxis);
	        	yAxisGroup.transition()
	        			  .attr('transform', 'translate (' + [xScale(ageRanges[0]), 0] + ')')
	        			  .call(yAxis);
	        };

	        // Update Bars
	        var updateBars = function updateBars(data) {

	        	var color = {
	        				  'male'   : '#3399FF',
	        				  'female' : '#FF3399',
	        				  '1Class' : '#B2D9B2',
	        				  '2Class' : '#008000',
	        				  '3Class' : '#002600'
	        				};

	        	// Group setup
	        	var barGroups = chartGroup.selectAll('.barGroup')
	        							  .data(data)
	        							  .enter()
						 				  .append('svg:g')
						 				  .attr('class', 'barGroup');

				// Stacked group setup
				var bars = barGroups.selectAll('.bar')
						 			.data(function(d) { return d; });

				bars.enter()
					.append('svg:rect')
					.attr('class', 'bar')
					.attr('width', xScale.rangeBand())
					.attr('x', function(d, i) { return xScale(d.AgeRange); })
					.attr('y', function(d, i) { return yScale(d.y0); })
					.attr('height', function(d, i) {
										return (yScale(0) - yScale(1)) / 2;
									})
					// .style('fill', 'lightblue');
					.style('fill', function(d) { return color[d.Sex]; });

				bars.transition()
					.attr('width', xScale.rangeBand())
					.attr('x', function(d, i) { return xScale(d.AgeRange); })
					.attr('y', function(d, i) { return yScale(d.y0); })
					.attr('height', function(d, i) { return yScale(0) - yScale(1); });

        		return bars;
	        };

			var updateChart = function updateChart(data) {
			    /*
			      D3.js setup code
			    */
		        "use strict";

		        // Format the data //
		        // Remove any empty values for Age, Fare, and Embarked
		        data = dataTrim(data, 'Age', 0);
		        data = dataTrim(data, 'Fare', 0);
		        data = dataTrim(data, 'Embarked', "");

				// Bin Passengers by age group
		        for (i = 0; i < data.length; i++) {
	        		if (data[i].Age < 10) {
				  		data[i].AgeRange = ageRanges[0];
	        		}
				  	else if (data[i].Age >= 10 && data[i].Age < 20) {
				  		data[i].AgeRange = ageRanges[1];
				  	}
				  	else if (data[i].Age >= 20 && data[i].Age < 30) {
				  		data[i].AgeRange = ageRanges[2];
				  	}
				  	else if (data[i].Age >= 30 && data[i].Age < 40) {
				  		data[i].AgeRange = ageRanges[3];
				  	}
				  	else if (data[i].Age >= 40 && data[i].Age < 50) {
				  		data[i].AgeRange = ageRanges[4];
				  	}
				  	else if (data[i].Age >= 50 && data[i].Age < 60) {
				  		data[i].AgeRange = ageRanges[5];
				  	}
				  	else if (data[i].Age >= 60) {
				  		data[i].AgeRange = ageRanges[6];
				  	}
		        }

		        // Collapse data by age ranges
		        var ages_data = [[],[],[],[],[],[],[]];
		        for (i = 0; i < data.length; i++) {
		        	for (j = 0; j < ageRanges.length; j++) {
			        	if (data[i].AgeRange === ageRanges[j]) {
			        		ages_data[j].push(data[i]);
			        	}
		        	}
		        }

		        // Sort by Gender
		        sortField = 'Sex'
		        ages_data = sortData(ages_data, sortField);

		        setupSpace();

		        var stacked_data = setupStack(ages_data);

		        updateScales(stacked_data);

		        updateAxis();

		        updateBars(stacked_data);
			};
		</script>
	</head>
	<body>
		<script type="text/javascript">
			// load the dataset
			d3.csv('titanic_survivors.csv', function(d) {
				d.Survived = +d.Survived;
				d.Age = +d.Age;
				d.SibSp = +d.SibSp;
				d.Parch = +d.Parch;
				d.Fare = +d.Fare;
				switch (d.Embarked) {
				  	case 'C':
				  		d.Embarked = 'Cherbourg, France';
				  		break;
				  	case 'Q':
				  		d.Embarked = 'Queenstown, Ireland';
				  		break;
				  	case 'S':
						d.Embarked = 'Southampton, UK';
				  		break;
				}
			    return d;
			}, updateChart);
		</script>
	</body>
</html>